Redis 3.2提供了GEO功能，支持存储地理位置信息用来实现类似微信中附近的人，嘀嘀打车附近车辆的功能，使用起来十分方便。

## 1、Redis GEO API

### 1.1添加地理位置信息

```shell
geoadd key longtitude latitude member [longtitude latitude member...]
```

eg：向cars:locations中增加车辆编号为1以及车辆编号为2的位置信息。

```shell
127.0.0.1:6379> geoadd cars:locations 120.346111 31.556381 1 120.375821 31.560368 2 
```

### 1.2、获取地理位置信息

```
geopos cities:locations member [member ...]
```

eg：获取车辆编号为1的车辆位置信息

```shell
127.0.0.1:6379> geopos cars:locations 1
1) 1) "120.34611314535140991"
   2) "31.55637987511895659"
```

### 1.3、获取两个地理位置的距离

```
geodist key member1 member2 [unit]
其中unit为可选参数，可选以下四种，默认 m：
- m：代表单位米 
- km：代表单位千米 
- mi：代表单位英里 
- ft：代表单位尺
```

eg：获取编号为1的车辆与编号为2的车辆之间的距离

```shell
127.0.0.1:6379> geodist cars:locations 1 2 km
"2.8504"
```

### 1.4、获取指定位置范围的地理信息位置集合

以给定的经纬度为中心， 返回键包含的位置元素当中， 与中心的距离不超过给定最大距离的所有位置元素。

```shell
GEORADIUS key longitude latitude radius m|km|ft|mi [WITHCOORD] [WITHDIST] [WITHHASH] [ASC|DESC] [COUNT count]
```

eg：以经度120.375821纬度31.556381为中心查找5公里范围内的车辆

```shell
127.0.0.1:6379> GEORADIUS cars:locations 120.375821 31.556381 5 km WITHCOORD WITHDIST WITHHASH  ASC COUNT 100
1) 1) "2"
   2) "0.4433"
   3) (integer) 4054421167795118
   4) 1) "120.37582129240036011"
      2) "31.5603669915025975"
2) 1) "1"
   2) "2.8157"
   3) (integer) 4054421060663027
   4) 1) "120.34611314535140991"
      2) "31.55637987511895659"
```

以给定的经纬度为中心， 返回键包含的位置元素当中， 与中心的距离不超过给定最大距离的所有位置元素。

范围可以使用以下其中一个单位：

- m 表示单位为米。
- km 表示单位为千米。
- mi 表示单位为英里。
- ft 表示单位为英尺。

在给定以下可选项时， 命令会返回额外的信息：

- WITHDIST ： 在返回位置元素的同时， 将位置元素与中心之间的距离也一并返回。 距离的单位和用户给定的范围单位保持一致。
- WITHCOORD ： 将位置元素的经度和维度也一并返回。
- WITHHASH ： 以 52 位有符号整数的形式， 返回位置元素经过原始 geohash 编码的有序集合分值。 这个选项主要用于底层应用或者调试， 实际中的作用并不大。 命令默认返回未排序的位置元素。 通过以下两个参数， 用户可以指定被返回位置元素的排序方式：
- ASC ： 根据中心的位置， 按照从近到远的方式返回位置元素。DESC ： 根据中心的位置， 按照从远到近的方式返回位置元素。
- 在默认情况下， GEORADIUS 命令会返回所有匹配的位置元素。 虽然用户可以使用 COUNT 选项去获取前 N 个匹配元素， 但是因为命令在内部可能会需要对所有被匹配的元素进行处理， 所以在对一个非常大的区域进行搜索时， 即使只使用 COUNT 选项去获取少量元素， 命令的执行速度也可能会非常慢。 但是从另一方面来说， 使用 COUNT 选项去减少需要返回的元素数量， 对于减少带宽来说仍然是非常有用的。

### 1.5、获取指定元素范围的地理信息位置集合

```
GEORADIUSBYMEMBER key member radius m|km|ft|mi [WITHCOORD] [WITHDIST] [WITHHASH] [ASC|DESC] [COUNT count]
```

eg：以编号为1的车辆为中心查找5公里范围内的车辆

```shell
127.0.0.1:6379> GEORADIUSBYMEMBER cars:locations 2 5 km WITHCOORD WITHDIST WITHHASH  ASC COUNT 100
1) 1) "2"
   2) "0.0000"
   3) (integer) 4054421167795118
   4) 1) "120.37582129240036011"
      2) "31.5603669915025975"
2) 1) "1"
   2) "2.8157"
   3) (integer) 4054421060663027
   4) 1) "120.34611314535140991"
      2) "31.55637987511895659"
```

## 2、数据结构

Redis在不同类型的数据时都有对应的编码方式。Redis GEO使用哪种编码方式进行存储呢？在翻阅Redis GEO文档会发现其没有删除相关的命令，因为底层使用zset实现的，所以可以使用zrem命令删除位置信息，也可以使用zset的查询命令查询位置信息。

```shell
127.0.0.1:6379> ZRANGE cars:locations  0 -1 WITHSCORES
1) "1"
2) "4054421060663027"
3) "2"
4) "4054421167795118"
```

发现车辆编号为1的位置信息为4054421060663027；车辆编号为2的位置信息为4054421167795118。 再回顾一下zset增加成员的指令

```shell
ZADD key score member [[score member] [score member] ...]
```

至此可以推断出Redis GEO 添加经、纬度位置信息的指令的过程是

```shell
ZADD cars:locations 4054421060663027 1
```

4054421060663027为对经纬度进行编码后的值。使用4054421060663027作为score 可以快速实现对经纬度的索引。查看相关文档发现Redis使用了geohash对经纬度信息进行的编码。