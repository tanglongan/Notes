### 一、如何保证消息不被重复消费？或者说保证消息消费的幂等性？

#### 首先大概说一说可能会有哪些重复消费？

首先，比如RabbitMQ、RocketMQ、Kafka都有可能会出现重复消费的问题，这很正常。因为这个问题不是MQ来保证的，而是有应用程序开发时保证的。通过一个Kafka来举例说明，说说怎么重复消费？kafka有一个offset的概念，代表消息的序号，然后consumer消费了数据之后，每隔一段时间会把自己消费过的消息的offset提交一下，表示“我已经消费过了，下次我要是重启啥的，就让我继续从上次消费到的offset来继续消费吧”。但是凡事总会有意外，比如有时候重启系统直接用kill进程了，再重启。这会导致consumer有些消息处理了，但是没来得及提交offset了。重启之后，就会再次消费一次。

举个栗子。

有这样一个场景，数据1/2/3依次进入kafka，kafka会给这三条数据每条分配一个offset，代表这条数据的需要，我们就需要分配的offset依次是152/153/154。消费者进程被重启了。那么消费过的数据1/2的offset没有被提交，kafka也就不知道已经消费了offset=153这条数据了。那么重启之后，消费者会找kafka说，嘿，哥们儿，你给我接着把我上次消费的那个地方后面的数据继续给我传递过来。由于之前的offset没有提交成功，那么数据1/2会再次传递过来，如果此时消费者没有去重过滤的话，就会导致重复消费，出现数据问题。

<img src="/Users/tanglongan/Notes/消息队列/.images//image-20201013162223393.png" alt="image-20201013162223393" style="zoom:80%;" />

举个栗子。假设有一个系统，消费一条数据，就往数据库里插入一条数据，要是一个消息重复两次，插入了两条数据，这样就出现了问题。但是要是消费到第二条数据的时候，先判断一下是否已经消费过，若是就直接扔掉了，这样不就保留了一条数据，从而保证了数据的正确性。

`一条数据重复出现两次，数据库里就只有一条数据，这样就保证了数据消费的幂等性。`

`幂等性，通俗点说，就是一个数据或者一个请求，给你重复来多次，你的确保对应的数据是不会改变的，不能出错。`

怎么保证幂等性？

其实还是得结合业务来思考，这里有几个思路：

* 比如拿个数据写库，先根据主键查一下，如果这数据有了，就插入数据了，直接更新即可。
* 比如数据是写入redis，那没问题了，反正redis每次都是set，天然的幂等性
* 比如不是上面两种情况，那做的稍微复杂一点，需要让生产者发送每条数据的时候，里面加一个全局唯一的ID，类似订单ID的东西，然后消费的时候，先根据ID去比如redis里面查询一下，之前消费过吗？没有，就处理数据后写入redis，如果消费过了，就不用处理了，保证别重复处理相同消息即可。

![image-20201013164217809](/Users/tanglongan/Notes/消息队列/.images//image-20201013164217809.png)

当然，如何保证MQ的消费是幂等性的，需要结合具体业务来看。

